#!/bin/bash

red="\033[0;31m"
green="\033[0;32m"
blue="\033[1;36m"
nocolor="\033[0m"

status=0

echo -en "${blue}"
echo "+---------------------------+"
echo "|   libft: MANDATORY PART   |"
echo "+---------------------------+"
echo -en "${nocolor}"

echo "+----------------+"
echo "|   NORMINETTE   |"
echo "+----------------+"

util/normcheck
if [ $? -ne 0 ]
then
	status=1
fi

echo "+---------------------+"
echo "|   COMPILE LIBRARY   |"
echo "+---------------------+"

make -s -C repo/ all clean
if [ $? -ne 0 ]
then
	../util/printtitle "${red}Errors while compiling the library${nocolor}"
	exit 1
else
	echo -e "${green}Library compiled successfully!${nocolor}"
fi

echo "+---------------------+"
echo "|   CHECK SYMBOLS     |"
echo "+---------------------+"

util/symbolcheck repo/libft.a libft/expected_funs libft/expected_refs

echo "+-------------------+"
echo "|   COMPILE TESTS   |"
echo "+-------------------+"

make -s  -C libft/ all clean
if [ $? -ne 0 ]
then
	../util/printtitle "${red}Errors while compiling tests${nocolor}"
	exit 1
else
	echo -e "${green}Tests compiled successfully!${nocolor}"
fi

echo "+-----------+"
echo "|   TESTS   |"
echo "+-----------+"

libft/bin/test
if [ $? -ne 0 ]
then
	status=1
fi

make -s -C libft/ fclean

if [ $(util/bonuscheck) == yes ]
then
	echo -en "${blue}"
	echo "+-----------------------+"
	echo "|   libft: BONUS PART   |"
	echo "+-----------------------+"
	echo -en "${nocolor}"

	echo "+-----------------------------+"
	echo "|   COMPILE LIBRARY (BONUS)   |"
	echo "+-----------------------------+"

	make -s -C repo/ bonus clean
	if [ $? -ne 0 ]
	then
		../util/printtitle "${red}Compilation errors were found${nocolor}"
		exit 1
	else
		echo -e "${green}Library compiled successfully!${nocolor}"
	fi

	echo "+-----------------------------+"
	echo "|   CHECK SYMBOLS (BONUS)     |"
	echo "+-----------------------------+"

	util/symbolcheck repo/libft.a libft/expected_funs_bonus libft/expected_refs

	echo "+---------------------------+"
	echo "|   COMPILE TESTS (BONUS)   |"
	echo "+---------------------------+"

	make -s  -C libft/ bonus clean
	if [ $? -ne 0 ]
	then
		../util/printtitle "${red}Errors while compiling tests${nocolor}"
		exit 1
	else
		echo -e "${green}Tests compiled successfully!${nocolor}"
	fi

	echo "+-------------------+"
	echo "|   TESTS (BONUS)   |"
	echo "+-------------------+"

	libft/bin/test_bonus
	if [ $? -ne 0 ]
	then
		status=1
	fi

	make -s -C libft/ fclean
else
	echo -e "${green}Bonus part not found!${nocolor}"
fi
